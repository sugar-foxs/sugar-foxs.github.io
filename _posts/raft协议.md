---
layout:     post
title:      raft协议
subtitle:   
date:       2021-05-10
author:     sugar-foxs
catalog: 	true
tags:
    - 分布式
    - 一致性协议
---

raft协议
<!-- more -->

常见的一致性算法有Paxos、Raft等，Paxos协议是Leslie Lamport于1990年提出的一种基于消息传递、具有高度容错性的一致性算法，Paxos算法解决的主要问题是分布式系统内如何就某个值达成一致。但Paxos有两个明显的缺点：1，Paxos算法难以理解。2，没有提供构建现实系统的良好基础，也有很多工程化Paxos算法的尝试，但是它们对Paxos算法本身做了比较大的改动，彼此之间的实现差距都比较大，实现的功能和目的有所不同，同时与Paxos算法的描述有很多出入。
Raft算法是一种用于管理复制日志的一致性算法，其功能与Paxos算法类似，但其算法结构和Paxos不同，设计者将易用理解作为其目标之一，这使得Raft算法更易于构建实际的系统，大幅度减少了工程化的工作量，也方便开发者在此基础上进行扩展。

# Leader选举
Raft协议功能做模式是Leader-follower模式。每个节点都维护了一个状态机，状态机有3个状态：Leader、Follower、Candidate。在任意时刻，集群中的任意一个节点都处于这3个状态之一。下面介绍下每个状态的节点负责的主要工作。
Leader节点：Leader节点负责处理所以客户端的请求，当接收到客户端的写入请求时，Leader节点会在本地追加一条响应的日志，然后将其封装成消息发送到集群中其他的Follower节点。当Follower节点接受到该消息时会对其进行响应。如果集群中多数（超过半数）节点都已收到该请求对应的日志记录时，则Leader节点认为该条日志已提交（Committed），可以向客户端返回响应。Leader还会处理客户端的只读请求。Leader的另一项工作是定期向集群中的Follower节点发送心跳消息，这主要是为了防止集群中的其他Follower节点的选举计时器超时而触发新一轮选举。

Follower节点：不会发生任何请求，它们只是简单的响应来自Leader或Candidate节点的请求；也不处理客户端的请求，而是将请求重定向给Leader节点处理。

Candidate节点：由Follower节点转化而来。当Follower节点长时间没有收到Leader节点发送的心跳消息时，则该节点的选举计时器机会过期，同时会将自身状态转换成Candidate，发起新一轮选举。

## Leader选举流程
1. 当集群初始化时，所有节点都处于Follower状态，此时的集群中没有Leader节点。当Follower节点一段时间（选举计时器超时）内收不到Leader节点的心跳消息，则认为Leader节点出现故障导致其任期过期，Follower节点会转换成Candidate节点，发起新一轮选举。所谓任期实际上就是一个全局的、连续递增的整数，在Raft协议中每进行一次选举，任期加一，在每个节点中都会记录当前的任期值。每一个任期都是从一次选举开始的，在选举时，会出现一个或者多个Candidate节点尝试承诺为Leader节点，如果其中一个Canndidate节点赢得选举，则该节点就会切换为Leader状态并成为该任期的Leader节点，直到该任期结束。

2. 如果两个或两个以上节点的选举计时器同时过期,则这些节点会同时由Follower状态切换成Candidate状态，然后同时触发新一轮选举。假设两个节点发起选举都没有成功成为Leader，这是会以选举失败结束，当任意节点的选举计时器到期之后，会再次发起新一轮的选举。因为选举超时时间是在一个时间区间内取的随机数，所以在配置合理的时候，像上述情况多次出现的概率不大。

## 日志复制
 

## 网络分区（脑裂）
网络分区：在集群中，有部分节点的网络发生故障，和其他一部分节点的连接中断
举例：集群中有5个节点A、B、C、D、E。A是leader节点，任期为1，此时其中A和B网络连通，CDE网络连通，但两部分之间网络故障，形成了网络分区。
1，随着时间流逝，与leader节点A隔离的CDE节点会有一个节点的选举超时器先超时，假设是E，此时E会切换为Candidate状态，并发起新一轮选举，因为网络分区的原因，只有CD节点能接受到E的选举请求，假设CD都投给了E，E收到了包含3票（包含自己），达到了集群半数以上，成为新任期（Term=2）的leader节点。
2，当网络故障修复时，网络分区消失，节点A此时认为自己是Leader，会发送心跳给CDE，CDE接受到心跳请求，但是由于请求中携带的Term小于当前CDE的term,会被CDE忽略。同时节点E也是leader节点，会发生心跳给AB,由于E发送的请求携带的term大于AB的term，所以A、B会切换为Follower状态，这样整个节点的leader节点就是E。
3，存在一种情况，A是leader，ABC在一个网络中，DE在一个网络中，DE分区由于节点数不足半数，无法选举出leader节点，会持续发起leader选举。这里raft协议有个优化，在节点发起选举之前，需要先进入PreVote的状态，在该状态下，节点会尝试连接集群中其他节点，只有成功连接到半数以上节点，才能真正发起新一轮leader选举。